{% extends "layout.html" %}
{% block content %}
<div class="welcome-header">
    <img src="{{ url_for('static', filename='logo/farm or fallow.svg') }}" 
        alt="Game Logo" 
        class="welcome-logo">
    <h1 class="page-title">Farm or Fallow? A Decision-Making Game</h1>
</div>
<div class="welcome-container">

    <!-- Introduction -->
    <div class="intro-card">
        <h2>Welcome, Farmer!</h2>
        <p>
            Welcome to <strong>"Farm or Fallow"</strong>!  
            In this game, you step into the role of a farmer somewhere in Europe, managing <strong>6 plots of land</strong> that have been in your family for generations.
        </p>
        <p>
            Every season you need to plan your farming activities and choose the crops you want to plant and harvest to support your livelihood.  
            You rely on the rains for your crops to grow, but adverse weather conditions may cause your harvest to fail.
        </p>
        <h3>Game Flow</h3>
        <p>
            You will play across <strong>two seasons</strong> (2022-2024). Each season has three phases:
        </p>
        <ol style="margin-left: 20px; line-height: 1.6;">
            <li><strong>Start of Season (November):</strong> Decide on planting grapes (permanent crop) and winter wheat.</li>
            <li><strong>Mid-Season (April):</strong> Decide on planting maize (if a plot is fallow) and choose mitigation options.</li>
            <li><strong>End-Season:</strong> Wrap up, harvest, and balance the books.</li>
        </ol>
        <p>
            At the end of two years, you will see an <strong>overview of your farm's performance</strong>.
        </p>
    </div>

    <!-- Location Selection and buttons to start the game -->
    <div class="map-card">
        <h2>Your First Step</h2>
        <p>
            Decide <strong>where your farm is located</strong>.  
            Click on the map below, confirm your choice, and start playing!
        </p>
        <p>
            Alternatively, you can also play using <strong>default data from Telavi, Georgia</strong>, 
            where this game was originally developed.
        </p>
        <div id="map" class="welcome-map"></div>
        <div class="welcome-btn-row">
            <!-- Location based start-button -->
            <button id="startBtn" disabled class="welcome-btn start-btn">
                Confirm Location & Start Game
            </button>
            <!-- Telavi button -->
            <button id="telaviBtn" class="welcome-btn telavi-btn">
                Start with Telavi Data
            </button>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <h2>Loading your farm data...</h2>
    <p>Please wait a moment while we prepare your game.</p>
</div>

<!-- Leaflet scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    let map = L.map('map').setView([48.5, 20.0], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // --- blue marker for Telavi, Georgien ---
    const telaviLatLng = [41.92, 45.47];
    const blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // --- green marker for selected location ---
    const greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    L.marker(telaviLatLng, {icon: blueIcon})
        .addTo(map)
        .bindTooltip('Telavi, Georgien');

    let selectedLatLng = null;
    let marker = null;

    map.on('click', function(e) {
        selectedLatLng = e.latlng;
        if (marker) {
            marker.setLatLng(selectedLatLng);
        } else {
            marker = L.marker(selectedLatLng, {icon: greenIcon}).addTo(map);
        }
        document.getElementById("startBtn").disabled = false;
    });

    document.getElementById("startBtn").addEventListener("click", function() {
        if (!selectedLatLng) return;

        // Display loading overlay
        document.getElementById("loadingOverlay").style.display = "flex";

        fetch("/start_game", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                lat: selectedLatLng.lat,
                lng: selectedLatLng.lng
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                document.getElementById("loadingOverlay").style.display = "none";
                alert("Something went wrong. Please try again.");
            }
        })
        .catch(err => {
            document.getElementById("loadingOverlay").style.display = "none";
            console.error("Error:", err);
            alert("Error starting the game.");
        });
    });

    document.getElementById("telaviBtn").addEventListener("click", function() {
        // Display loading overlay
        document.getElementById("loadingOverlay").style.display = "flex";

        fetch("/start_game_telavi", {
            method: "POST",
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                document.getElementById("loadingOverlay").style.display = "none";
                alert("Something went wrong. Please try again.");
            }
        })
        .catch(err => {
            document.getElementById("loadingOverlay").style.display = "none";
            console.error("Error:", err);
            alert("Error starting the game with Telavi data.");
        });
    });
</script>
{% endblock %}
